# https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#workflow_dispatch
name: ApiSkopeoImageCopier
run-name: Copy ${{ inputs.source }} -> ${{ inputs.target }} by @${{ github.actor }} [${{ inputs.distinct_id || 'N/A' }}]

on:
  workflow_dispatch:
    inputs:
      source:
        description: '源镜像（必填）。可填 `docker://...` 全引用，或简写 `nvcr.io/nvidia/tritonserver:25.10-py3`（默认按 docker）'
        required: true
        type: string
      target:
        description: '目标镜像（必填）。可填 `docker://...` 全引用，或简写 `repo/image:tag`（自动拼阿里云命名空间）'
        required: true
        type: string
      platform:
        description: '可选。指定则复制单架构，如 `linux/amd64` 或 `linux/arm64`；不填默认复制多架构'
        required: false
        type: string
      additional_copy_opts:
        description: '可选。附加 skopeo copy 参数（空格分隔），如 `--src-tls-verify=false --retry-times 5`'
        required: false
        type: string
      dry_run:
        description: '可选。仅打印最终命令，不执行'
        required: false
        default: false
        type: boolean
      distinct_id:
        description: 'Distinct ID'
        required: false
        type: string

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  SOURCE_REGISTRY_USER: "${{ secrets.SOURCE_REGISTRY_USER }}"
  SOURCE_REGISTRY_PASSWORD: "${{ secrets.SOURCE_REGISTRY_PASSWORD }}"
  SOURCE: ${{ github.event.inputs.source }}
  TARGET: ${{ github.event.inputs.target }}
  PLATFORM: ${{ github.event.inputs.platform }}
  ADDITIONAL_COPY_OPTS: ${{ github.event.inputs.additional_copy_opts }}
  DRY_RUN: ${{ github.event.inputs.dry_run }}

jobs:
  skopeo-copy:
    name: Copy image with skopeo
    runs-on: ubuntu-latest
    steps:
      - name: Show inputs
        run: |
          echo "SOURCE=$SOURCE"
          echo "TARGET=$TARGET"
          echo "PLATFORM=$PLATFORM"
          echo "DRY_RUN=$DRY_RUN"

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
          skopeo --version

      - name: Build refs and copy
        shell: bash
        run: |
          set -euo pipefail

          # Defaults: full multi-arch copy with TLS verify and basic retry.
          DEFAULT_SRC_TLS_VERIFY="true"
          DEFAULT_DEST_TLS_VERIFY="true"
          DEFAULT_RETRY_TIMES="3"

          parse_or_default_ref() {
            local input_ref="$1"
            local default_transport="$2"
            if [[ "$input_ref" == *"://"* ]]; then
              echo "$input_ref"
            else
              echo "${default_transport}://${input_ref}"
            fi
          }

          normalize_registry_host() {
            local host="$1"
            host="${host#docker://}"
            host="${host#https://}"
            host="${host#http://}"
            host="${host%%/}"
            echo "$host"
          }

          resolve_docker_target() {
            local t="$1"
            local first_segment
            local aliyun_registry_normalized
            first_segment="$(echo "$t" | cut -d'/' -f1)"
            if [[ "$first_segment" == *.* || "$first_segment" == *:* || "$first_segment" == "localhost" ]]; then
              echo "$t"
              return 0
            fi

            if [[ -z "${ALIYUN_REGISTRY:-}" || -z "${ALIYUN_NAME_SPACE:-}" ]]; then
              echo "ALIYUN_REGISTRY 或 ALIYUN_NAME_SPACE 未配置，且 target 不是完整镜像名" >&2
              return 1
            fi
            aliyun_registry_normalized="$(normalize_registry_host "${ALIYUN_REGISTRY}")"
            echo "${aliyun_registry_normalized}/${ALIYUN_NAME_SPACE}/${t}"
          }

          extract_registry_from_docker_ref() {
            local docker_ref="$1"
            local without_scheme="${docker_ref#docker://}"
            echo "${without_scheme%%/*}"
          }

          source_ref="$(parse_or_default_ref "$SOURCE" "docker")"

          if [[ "$TARGET" == *"://"* ]]; then
            target_ref="$TARGET"
          else
            target_resolved="$(resolve_docker_target "$TARGET")"
            target_ref="docker://${target_resolved}"
          fi

          copy_cmd=(skopeo copy)
          copy_cmd+=(--src-tls-verify="${DEFAULT_SRC_TLS_VERIFY}")
          copy_cmd+=(--dest-tls-verify="${DEFAULT_DEST_TLS_VERIFY}")
          copy_cmd+=(--retry-times "${DEFAULT_RETRY_TIMES}")

          # If platform is not provided, keep full manifest list.
          if [[ -n "${PLATFORM:-}" ]]; then
            IFS='/' read -r platform_os platform_arch _ <<< "${PLATFORM}"
            if [[ -z "${platform_os:-}" || -z "${platform_arch:-}" ]]; then
              echo "platform 格式错误，请使用 linux/amd64 或 linux/arm64" >&2
              exit 1
            fi
            copy_cmd+=(--override-os "${platform_os}")
            copy_cmd+=(--override-arch "${platform_arch}")
          else
            copy_cmd+=(--all)
          fi

          if [[ -n "${SOURCE_REGISTRY_USER:-}" && -n "${SOURCE_REGISTRY_PASSWORD:-}" ]]; then
            copy_cmd+=(--src-creds "${SOURCE_REGISTRY_USER}:${SOURCE_REGISTRY_PASSWORD}")
          fi

          if [[ "${target_ref}" == docker://* && -n "${ALIYUN_REGISTRY_USER:-}" && -n "${ALIYUN_REGISTRY_PASSWORD:-}" ]]; then
            copy_cmd+=(--dest-creds "${ALIYUN_REGISTRY_USER}:${ALIYUN_REGISTRY_PASSWORD}")
          fi

          if [[ -n "${ADDITIONAL_COPY_OPTS:-}" ]]; then
            read -r -a extra_opts <<< "${ADDITIONAL_COPY_OPTS}"
            copy_cmd+=("${extra_opts[@]}")
          fi

          copy_cmd+=("${source_ref}" "${target_ref}")

          echo "Final source ref: ${source_ref}"
          echo "Final target ref: ${target_ref}"

          # Preflight login to make auth errors explicit before copy starts.
          if [[ "${target_ref}" == docker://* ]]; then
            target_registry="$(extract_registry_from_docker_ref "${target_ref}")"
            echo "Resolved target registry: ${target_registry}"
            if [[ -n "${ALIYUN_REGISTRY_USER:-}" && -n "${ALIYUN_REGISTRY_PASSWORD:-}" ]]; then
              echo "Preflight login to target registry with ALIYUN_REGISTRY_USER"
              skopeo login --username "${ALIYUN_REGISTRY_USER}" --password "${ALIYUN_REGISTRY_PASSWORD}" "${target_registry}"
            else
              echo "Target is docker transport but ALIYUN_REGISTRY_USER/ALIYUN_REGISTRY_PASSWORD is empty" >&2
              exit 1
            fi
          fi

          if [[ "${source_ref}" == docker://* && -n "${SOURCE_REGISTRY_USER:-}" && -n "${SOURCE_REGISTRY_PASSWORD:-}" ]]; then
            source_registry="$(extract_registry_from_docker_ref "${source_ref}")"
            echo "Preflight login to source registry: ${source_registry}"
            skopeo login --username "${SOURCE_REGISTRY_USER}" --password "${SOURCE_REGISTRY_PASSWORD}" "${source_registry}"
          fi

          printf 'Final command: %q ' "${copy_cmd[@]}"
          printf '\n'

          if [[ "${DRY_RUN}" == "true" ]]; then
            echo "DRY_RUN=true, skip copy."
            exit 0
          fi

          "${copy_cmd[@]}"
          echo "Copy completed."
